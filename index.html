<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Astralyn Academy — A Whimsical Gothic Tale</title>
  <!-- Branding & social cards -->
  <meta name="author" content="realrealro">
  <meta name="description" content="A whimsical gothic micro‑adventure by realrealro. Doors don’t always stay where you left them.">
  <meta property="og:title" content="Astralyn Academy — Interactive Micro‑Adventure" />
  <meta property="og:description" content="A mystical branching story by realrealro. Choose carefully; doors listen." />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1200' height='630'%3E%3Crect width='100%25' height='100%25' fill='%232a1757'/%3E%3Ccircle cx='300' cy='315' r='160' fill='%23e9dcff'/%3E%3Ccircle cx='360' cy='315' r='160' fill='%232a1757'/%3E%3C/svg%3E" />
  <!-- Favicon: crescent moon -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cpath fill='%23e9dcff' d='M38 8a18 18 0 1 0 0 48a21 21 0 1 1 0-48z'/%3E%3C/svg%3E">
  <!-- Fonts: mystical titles + readable body -->
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Spectral:ital,wght@0,300;0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
  <style>
    :root{
      /* Refined fantasy palette */
      --bg-deep: #120f24;      /* midnight indigo */
      --bg-grad: #2a1757;      /* deep amethyst */
      --bg-pop:  #5f2da8;      /* royal violet */
      --card: #211739;         /* eggplant */
      --ink: #F3EEFF;          /* moonlit parchment */
      --muted: #CBBCEB;        /* lavender mist */
      --accent: #D8B4FE;       /* star lilac */
      --accent-2: #F6C56B;     /* gilded highlight */
      --shadow: rgba(0,0,0,.25);
      --radius: 20px;
      --maxw: 820px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--ink);
      background:
        radial-gradient(900px 600px at 15% 0%, #351a6b33, transparent 60%),
        radial-gradient(1200px 800px at 80% 100%, #8a2be233, transparent 60%),
        radial-gradient(1200px 800px at 20% 10%, var(--bg-grad), var(--bg-deep)) fixed;
      font-family: Spectral, Georgia, serif;
      line-height:1.7; letter-spacing:.15px; overflow-x:hidden;
    }

    /* Animated starfield + vignette */
    .stars, .stars::before, .stars::after{
      content:""; position:fixed; inset:0; pointer-events:none; background-repeat:repeat; mix-blend-mode:screen;
      background-image: radial-gradient(2px 2px at 20% 30%, #ffffff 60%, transparent 61%),
                        radial-gradient(2px 2px at 70% 80%, #ffffff 60%, transparent 61%),
                        radial-gradient(1.5px 1.5px at 40% 60%, #ffffff 60%, transparent 61%),
                        radial-gradient(1.5px 1.5px at 85% 20%, #ffffff 60%, transparent 61%);
      animation: drift 50s linear infinite; opacity:.22;
    }
    .stars::before{animation-duration: 75s; opacity:.16}
    .stars::after{animation-duration: 110s; opacity:.12}
    @keyframes drift{0%{transform:translate3d(0,0,0)}50%{transform:translate3d(-12px,-10px,0)}100%{transform:translate3d(0,0,0)}}

    .wrap{max-width:var(--maxw); margin: min(8vh,64px) auto; padding: 0 16px;}

    .card{
      position: relative;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 24px 60px var(--shadow);
      border-radius: var(--radius);
      padding: clamp(20px, 4vw, 30px);
      backdrop-filter: blur(6px);
      overflow: hidden;
    }
    /* Dragon watermark (subtle) */
    .card svg#dragon{ position:absolute; right:-80px; bottom:-60px; width:380px; height:auto; opacity:.065; filter: blur(0.3px); pointer-events:none }

    h1{
      font-family: Cinzel, serif; font-weight:700; letter-spacing:.4px;
      margin:0 0 8px; font-size: clamp(30px, 5.2vw, 46px);
      text-shadow: 0 2px 12px rgba(0,0,0,.25);
    }
    .subtitle{color:var(--muted); margin:0 0 18px; font-family: Cinzel, serif; letter-spacing:.3px}

    #scene{font-size: clamp(16px, 2.9vw, 19px); margin: 10px 0 18px}

    .choices{display:grid; gap:10px; grid-template-columns: 1fr;}
    button.choice{
      position:relative; overflow:hidden; isolation:isolate;
      width:100%; border:none; border-radius: 14px; padding:14px 16px;
      background: linear-gradient(180deg, #55308e, #3b246b);
      color:var(--ink); font-weight:600; cursor:pointer; text-align:left;
      box-shadow: 0 12px 20px rgba(43,25,77,.45);
      transition: transform .06s ease, box-shadow .2s ease, background .2s ease;
      text-shadow: 0 1px 0 rgba(0,0,0,.2);
    }
    /* Magic glyphs on hover */
    button.choice::after{
      content:'✧'; position:absolute; right:14px; top:50%; transform: translateY(-50%) scale(0.8) rotate(0deg);
      font-family: Cinzel, serif; font-size:20px; opacity:.0; color:var(--accent);
      transition: transform .25s ease, opacity .25s ease; filter: drop-shadow(0 0 6px rgba(216,180,254,.65));
    }
    button.choice:hover{transform: translateY(-1px); box-shadow:0 14px 22px rgba(43,25,77,.50)}
    button.choice:hover::after{opacity:.9; transform: translateY(-50%) scale(1) rotate(12deg)}
    button.choice:active{transform: translateY(0)}

    .hud{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-top:16px; flex-wrap: wrap}
    .tag{
      display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px;
      background: rgba(216,180,254,.13); border:1px solid rgba(216,180,254,.35); color:var(--muted);
      font-size: 13px;
    }
    .actions{display:flex; gap:8px;}
    .ghost{
      background: transparent; border:1px solid rgba(255,255,255,.18); color:var(--ink); padding:10px 12px; border-radius:10px; cursor:pointer;
    }
    .primary{
      background: linear-gradient(180deg, #a57bff, #8e66ef); border:0; color:#100b1b; font-weight:700; padding:10px 16px; border-radius:10px; cursor:pointer;
      box-shadow: 0 8px 20px rgba(104,82,190,.35);
    }
    .tiny{font-size:12px; opacity:.85}
    a{color:var(--accent)}

    details.cast{margin-top:8px}
    details.cast summary{cursor:pointer; color:var(--muted)}

    /* Riddle UI */
    .puzzle{margin:12px 0 6px; padding:12px; border:1px solid rgba(255,255,255,.12); border-radius:12px; background: rgba(255,255,255,.03)}
    .wheels{display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; margin-top:8px}
    .wheel{display:flex; flex-direction:column; align-items:center; gap:8px; padding:12px; background: linear-gradient(180deg,#2f2350,#261c42); border-radius:12px; border:1px solid rgba(255,255,255,.08)}
    .wheel .face{font-family:Cinzel,serif; font-size:32px; transform: rotateX(0); transition: transform .25s ease}
    .wheel.rot .face{transform: rotateX(360deg)}
    .wheel .name{font-size:12px; color:var(--muted)}
    .wheel button{border:1px solid rgba(255,255,255,.15); background:transparent; color:var(--ink); padding:6px 10px; border-radius:8px; cursor:pointer}
    .riddle-hint{color:var(--muted); font-size:14px; margin-top:8px}
    .assist{display:flex; gap:8px; margin-top:10px}

    /* Journal overlay */
    .overlay{position:fixed; inset:0; display:none; place-items:center; background:rgba(9,7,18,.55); backdrop-filter: blur(4px); z-index:20}
    .overlay.show{display:grid}
    .journal{
      width:min(820px, 92vw); max-height:80vh; overflow:auto;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.12); border-radius:16px; padding:18px 18px 8px;
      box-shadow: 0 24px 60px rgba(0,0,0,.35); position:relative;
    }
    .journal h2{font-family:Cinzel,serif; margin:0 0 8px}
    .closeX{position:absolute; top:10px; right:10px; border:1px solid rgba(255,255,255,.18); background:transparent; color:var(--ink); padding:6px 10px; border-radius:10px; cursor:pointer}
    .entry{margin:10px 0; padding:12px; border-left:3px solid rgba(216,180,254,.35); background:rgba(255,255,255,.03); border-radius:10px}
    .entry h3{margin:0 0 6px; font-family:Cinzel,serif}
    .entry small{color:var(--muted)}
    .sigil{float:right; margin-left:12px; opacity:.12; font-size:28px; filter: drop-shadow(0 0 6px rgba(216,180,254,.55))}

    /* Responsive */
    @media (min-width: 760px){ .choices{grid-template-columns: 1fr 1fr} }

    /* Splash / Landing */
    .splash{position:fixed; inset:0; display:grid; place-items:center; background:radial-gradient(1000px 700px at 20% 10%, rgba(93,59,168,.35), rgba(18,15,36,.92)); z-index:30}
    .splash .panel{width:min(860px,92vw); background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03)); border:1px solid rgba(255,255,255,.15); border-radius:20px; padding:22px 22px 16px; box-shadow:0 24px 60px rgba(0,0,0,.45); position:relative}
    .splash h1{font-family:Cinzel,serif; margin:0 0 8px}
    .splash p{margin:8px 0 14px}
    .splash .cta{display:flex; gap:10px; flex-wrap:wrap}
    .splash .cta .primary{font-size:16px}
    .splash .meta{display:flex; gap:12px; align-items:center; color:var(--muted); font-size:13px}
    .splash .brand{margin-left:auto}

    /* Footer */
    footer.site{max-width:var(--maxw); margin:24px auto 40px; padding:0 16px; color:var(--muted); font-size:12px; text-align:center; opacity:.85}
    footer.site a{color:var(--accent)}
  </style>
</head>
<body>
  <div class="stars" aria-hidden="true"></div>
  <div class="wrap">
    <div class="card" role="main" aria-live="polite">
      <!-- Subtle dragon watermark (inline SVG) -->
      <svg id="dragon" viewBox="0 0 512 512" aria-hidden="true">
        <path fill="currentColor" d="M256 32c-34 0-64 18-82 46 24-6 51 1 69 17 25-22 64-29 99-11-41 2-73 16-86 41 44 6 78 25 96 55-46-21-84-23-112-7 67 12 114 52 122 108-35-45-86-58-145-38 57 1 96 32 104 79-31-28-72-34-117-17 41 6 67 28 74 61-47-29-101-10-125 33 1-43 22-75 57-93-52-5-89 27-96 82-22-53-6-120 41-163-54 14-90 61-92 127C60 219 112 120 206 84c-31-3-62 7-88 27 27-43 77-79 138-79z" />
      </svg>

      <h1>Astralyn Academy</h1>
      <p class="subtitle">A whimsical gothic micro‑adventure</p>

      <div id="scene"></div>
      <div class="choices" id="choices"></div>

      <div class="hud">
        <div class="tag" id="status">Elara · Chapter One</div>
        <div class="actions">
          <button class="ghost" id="journalBtn" title="Open character journal">☆ Journal</button>
          <button class="ghost" id="back" title="Go back one step">← Back</button>
          <button class="ghost" id="sound" title="Toggle ambience">♪ Sound</button>
          <button class="ghost" id="restart" title="Start over">↺ Restart</button>
          <button class="primary" id="share" title="Copy shareable link">Share</button>
        </div>
      </div>

      <details class="cast" id="castbox">
        <summary>Who’s who (tap to view)</summary>
        <p class="tiny">Cast: <strong>Elara Thornfield</strong> (our inquisitive researcher), <strong>Lyra Windmere</strong> (mysterious librarian), <strong>Finn Alderidge</strong> (friendly student), and <strong>Aurelius</strong> (the guardian).</p>
      </details>
    </div>
  </div>

  <!-- Splash / Landing -->
  <div class="splash" id="splash" hidden>
    <div class="panel">
      <h1>Astralyn Academy</h1>
      <p class="subtitle">A whimsical gothic micro‑adventure</p>
      <p id="tagline">A violet door appears after midnight. Do you open it… or ask the library first?</p>
      <div class="cta">
        <button class="primary" id="startGame">▶ Start</button>
        <button class="ghost" id="viewJournal">☆ Journal</button>
        <a class="ghost" href="#prologue" id="skipToPrologue">Skip</a>
      </div>
      <div class="meta"><span>by <strong>realrealro</strong></span><span>•</span><span>© 2025</span><a class="brand" href="#" id="brandLink" title="Creator profile (set later)">✨</a></div>
    </div>
  </div>

  <!-- Character Journal Overlay -->
  <div class="overlay" id="journalOverlay" aria-hidden="true">
    <div class="journal" role="dialog" aria-modal="true" aria-labelledby="jrnlTitle">
      <button class="closeX" id="closeJournal" title="Close journal">✕</button>
      <h2 id="jrnlTitle">Enchanted Character Journal</h2>
      <div id="journalBody"></div>
    </div>
  </div>

  <!-- Character Journal Overlay -->
  <div class="overlay" id="journalOverlay" aria-hidden="true">
    <div class="journal" role="dialog" aria-modal="true" aria-labelledby="jrnlTitle">
      <button class="closeX" id="closeJournal" title="Close journal">✕</button>
      <h2 id="jrnlTitle">Enchanted Character Journal</h2>
      <div id="journalBody"></div>
    </div>
  </div>

  <footer class="site">© 2025 <strong>realrealro</strong>. All rights reserved. This page and story are originals created for Astralyn Academy.</footer>

  <script>
    // --- Simple state + router for a branching story ---
    const state = {
      lore: false,          // learned extra lore before entering
      boon: false,          // earned guardian's favor/boon
      grumpy: false,        // annoyed the guardian
      fails: 0,             // riddle fail count
      tookLantern: false,   // Finn choice flag for secret paths
      history: [],          // simple back stack (does not undo flags)
      visited: new Set(),
      characters: { elara:true, finn:false, lyra:false, aurelius:false },
      notes: { finnDeep:false, aureliusDeep:false },
    };

    const $scene = document.getElementById('scene');
    const $choices = document.getElementById('choices');
    const $status = document.getElementById('status');
    const $back = document.getElementById('back');

    // --- SFX/ambience via WebAudio (warmer, mystical) ---
    let audioCtx = null, isPlaying = false, padNodes = [];
    function ctx(){ return audioCtx || (audioCtx = new (window.AudioContext||window.webkitAudioContext)()); }
    function tone(freq=660, type='sine', dur=0.25, vol=0.05){
      const ac = ctx();
      const o = ac.createOscillator();
      const g = ac.createGain();
      const f = ac.createBiquadFilter();
      f.type = 'lowpass'; f.frequency.value = 4000;
      o.type = type; o.frequency.value = freq; g.gain.value = 0.0001;
      o.connect(g).connect(f).connect(ac.destination);
      const t = ac.currentTime;
      g.gain.linearRampToValueAtTime(vol, t+0.02);
      g.gain.exponentialRampToValueAtTime(0.00001, t+dur);
      o.start(); o.stop(t+dur+0.05);
    }
    const sfx = {
      click(){ tone(520,'triangle',0.12,0.035); },
      tick(){ tone(760,'sine',0.08,0.03); },
      success(){ tone(880,'triangle',0.22,0.05); setTimeout(()=>tone(1320,'triangle',0.22,0.045),140); },
      fail(){ tone(260,'sine',0.28,0.03); },
      gate(){ tone(330,'sine',0.9,0.035); setTimeout(()=>tone(280,'sine',0.9,0.03),220); }
    };

    function startAmbience(){
      if(isPlaying) return; const ac = ctx();
      const base = 246.94; // B3 warmer
      const gains = [];
      for(const ratio of [1, 5/4, 3/2, 9/8]){ // B, D#, F#, C#
        const osc = ac.createOscillator(); osc.type = 'sine'; osc.frequency.value = base * ratio;
        const g = ac.createGain(); g.gain.value = 0.0001; osc.connect(g).connect(ac.destination); osc.start();
        padNodes.push({osc, g}); gains.push(g);
      }
      let t = ac.currentTime; gains.forEach(g=> g.gain.linearRampToValueAtTime(0.04, t+1.8));
      const id = setInterval(()=>{ if(!isPlaying) { clearInterval(id); return; }
        const pitch = 880 * (1 + Math.random()*0.35); tone(pitch,'triangle',2.4,0.028);
      }, 5200 + Math.random()*2400);
      isPlaying = true; document.getElementById('sound').textContent = '♪ Sound: On';
    }
    function stopAmbience(){ if(!isPlaying) return; const ac = ctx();
      padNodes.forEach(({osc,g})=>{ try{ g.gain.exponentialRampToValueAtTime(0.00001, ac.currentTime+1.2); osc.stop(ac.currentTime+1.3);}catch(e){} }); padNodes = []; isPlaying = false; document.getElementById('sound').textContent = '♪ Sound: Off'; }
    function toggleAmbience(){ if(!isPlaying) startAmbience(); else stopAmbience(); }

    // UI hooks
    document.addEventListener('click', e=>{ if(e.target.matches('button')) sfx.click(); }, true);

    // Friendlier on-ramp: Prologue scene
    const scenes = {
      prologue: {
        text: `Welcome to <strong>Astralyn Academy</strong>—a place where moonlight hides in the stacks and doors sometimes change their minds. You’ll read, choose, and see what unfolds. Curious?` ,
        choices: [ { label: "Begin the night.", go: "intro" }, { label: "How to play (short)", go: "howto" } ]
      },
      howto: {
        text: `Pick from the choices. Your decisions tweak the story (and a few subtle flags). You can go back one step, or hit Restart anytime. Hints await if puzzles feel stubborn. Ready?`,
        choices: [ { label: "Let’s go.", go: "intro" } ]
      },

      intro: {
        text: `It’s past midnight at <em>Astralyn Academy</em>. The library is quiet enough to hear the ink drying. A door that wasn’t there at dusk breathes a soft violet glow. You’re <strong>Elara Thornfield</strong>, new to campus and chasing rumors of a cosmic gate. The air smells like old vellum and a hint of rain.`,
        choices: [
          { label: "Open the glowing door.", go: "star_corridor" },
          { label: "Hold off and investigate first.", go: "investigate" },
        ]
      },

      investigate: {
        text: `Secrets prefer patience. A dim lamp burns in the librarian’s nook. You could ask <strong>Lyra Windmere</strong> a careful question—or brave the Restricted Stacks alone.`,
        choices: [
          { label: "Speak with Lyra Windmere.", go: "with_lyra" },
          { label: "Search the Restricted Stacks myself.", go: "stacks" },
        ]
      },

      with_lyra: {
        text: `<strong>Lyra</strong> studies you over half‑moon spectacles. “The door answers intent,” she says, slipping you a moon‑sigil pendant. “For sight in the dark between stars.”`,
        enter(){ state.lore = true; state.characters.lyra = true; },
        choices: [ { label: "Back to the door.", go: "star_corridor" } ]
      },

      stacks: {
        text: `Dust blooms as you leaf through astral charts. A note tucked inside whispers: “<em>Align the Heir’s three constellations</em>.” The parchment tingles with warding ink.`,
        enter(){ state.lore = true; },
        choices: [
          { label: "Return to the door.", go: "star_corridor" },
          { label: "Pocket the chart and slip deeper...", go: "secret_annex_hint" },
        ]
      },

      star_corridor: {
        enter(){ state.characters.finn = true; },
        text: `The door sighs open. A corridor of slow‑turning starlight unfolds. <strong>Finn Alderidge</strong> edges from a column of shadow with a smile. “You saw it too,” he says, offering a small lantern.`,
        choices: [
          { label: "Accept Finn’s lantern and proceed.", go: "guardian", on(){ state.tookLantern = true; } },
          { label: "Thank him but go alone.", go: "guardian_alone", on(){ state.tookLantern = false; } },
        ]
      },

      guardian: {
        text: `At the corridor’s end coils <strong>Aurelius</strong>, a dragon carved from night and gold. “Answer, and pass,” the guardian rumbles. Constellations spin overhead.`,
        enter(){ state.characters.aurelius = true; },
        choices: [
          { label: "Solve the riddle by aligning the constellations.", go: "riddle" },
          { label: "Force the gate—trust instinct over riddles.", go: "force_gate" },
        ]
      },

      guardian_alone: {
        enter(){ state.characters.aurelius = true; },
        text: `Alone, you step beneath Aurelius’s gaze. The dragon tilts his horned crown. “Some paths favor solitude. Will yours?”`,
        choices: [
          { label: "Study the constellations carefully.", go: "riddle" },
          { label: "Push ahead before doubt can root.", go: "force_gate" },
        ]
      },

      riddle: {
        enter(){ if(state.lore){ state.boon = true; } sfx.tick(); },
        customRender(){
          $scene.innerHTML = `<p>${state.lore
            ? 'The moon‑sigil warms. Three astral wheels surface: <em>Heir</em>, <em>Vessel</em>, <em>Watcher</em>. Align them to open the gate.'
            : 'Three stubborn astral wheels grind up from the floor. Align the right pattern to open the gate.'}</p>`;

          const target = [3,1,5];                       // ✺, ✦, ✸
          const secret = [2,2,2];                       // ✹✹✹ → secret Annex
          const symbols = ['✶','✦','✹','✺','✷','✸'];   // 0..5
          const names = ['Heir','Vessel','Watcher'];
          const values = [ state.lore ? 3 : 0, state.lore ? 1 : 0, state.lore ? 5 : 0 ]; // pre-fill aid if lore

          const cont = document.createElement('div'); cont.className = 'puzzle'; cont.innerHTML = `<div class="wheels"></div>`; $scene.appendChild(cont);
          const grid = cont.querySelector('.wheels');

          function wheel(i){
            const box = document.createElement('div'); box.className = 'wheel';
            box.innerHTML = `
              <div class="name">${names[i]}</div>
              <div class="face" id="face${i}">${symbols[values[i]]}</div>
              <div>
                <button id="l${i}">◀</button>
                <button id="r${i}">▶</button>
              </div>`;
            grid.appendChild(box);
            document.getElementById(`l${i}`).addEventListener('click',()=>{ values[i]=(values[i]+symbols.length-1)%symbols.length; update(i); });
            document.getElementById(`r${i}`).addEventListener('click',()=>{ values[i]=(values[i]+1)%symbols.length; update(i); });
          }
          for(let i=0;i<3;i++) wheel(i);

          const hint = document.createElement('div'); hint.className = 'riddle-hint';
          hint.innerHTML = state.lore ? 'Lyra\'s note: “Align the Heir\'s three constellations.” The <em>Heir</em> prefers <strong>rare stars</strong>.' : 'Some patterns repeat across founders. Listen for the gate\'s hum.';
          cont.appendChild(hint);

          const tools = document.createElement('div'); tools.className = 'assist';
          const hintBtn = document.createElement('button'); hintBtn.className='ghost'; hintBtn.textContent='Hint';
          const storyBtn = document.createElement('button'); storyBtn.className='ghost'; storyBtn.textContent='Story Mode (skip)';
          tools.append(hintBtn, storyBtn); cont.appendChild(tools);

          const proceed = document.createElement('button'); proceed.className = 'choice'; proceed.textContent = 'Step through the unveiled gate.';
          proceed.disabled = true; proceed.style.opacity = .6; proceed.addEventListener('click', ()=> { sfx.gate(); render('revelation'); });
          $choices.innerHTML = ''; $choices.appendChild(proceed);

          let hintedIndex = 0; let idleHints = 0;
          hintBtn.addEventListener('click', ()=>{ idleHints++; if(idleHints>=3){ render('secret_specter'); return; }
            const reveal = target[hintedIndex]; values[hintedIndex] = reveal; update(hintedIndex, true); hintedIndex = Math.min(hintedIndex+1,2);
          });
          storyBtn.addEventListener('click', ()=>{ values[0]=target[0]; values[1]=target[1]; values[2]=target[2]; update(2,true); });

          function update(i, quiet){
            document.getElementById(`face${i}`).textContent = symbols[values[i]];
            document.getElementById(`face${i}`).parentElement.classList.add('rot');
            setTimeout(()=>document.getElementById(`face${i}`).parentElement.classList.remove('rot'),180);
            if(!quiet) sfx.tick();
            const ok = values.every((v,idx)=> v===target[idx]);
            const isSecret = values.every((v,idx)=> v===secret[idx]);
            if(isSecret){ render('secret_annex'); return; }
            proceed.disabled = !ok; proceed.style.opacity = ok?1:.6;
          }
        }
      },

      force_gate: {
        enter(){ state.grumpy = true; },
        text: `You push your will into the seam of reality. The corridor shivers. Aurelius’s frill lifts—yet the gate yields, a little offended.`,
        choices: [
          { label: "Face Aurelius and accept a penitent task.", go: "appease" },
          { label: "Slip through quickly while it’s open.", go: "revelation" },
        ]
      },

      appease: {
        enter(){ state.boon = false; },
        text: `“Power without witness tends to wander,” Aurelius says. “Speak a vow.” You promise to seek knowledge with care. The gate settles, grudging but clear.`,
        choices: [ { label: "Proceed through the gate.", go: "revelation" } ]
      },

      revelation: {
        text(){
          const lines = [];
          lines.push(`Beyond the threshold lies a sky‑lit rotunda—astral maps and dragon‑script circling a stone dais. A sigil answers your presence.`);
          if(state.boon){ lines.push(`<em>Favor clings like perfume.</em> A hidden panel opens, revealing the Founders’ ledger: Astralyn was raised by stargazers and dragon‑keepers to tend this very gate.`); state.notes.aureliusDeep = true; }
          else if(state.grumpy){ lines.push(`The air is watchful. Your steps echo. You are admitted, not embraced. The truth remains: Astralyn’s founders tended this gate to guard what waits beyond.`); }
          else { lines.push(`You catch enough to understand: Astralyn’s founders tended this gate to guard what waits beyond.`); }
          // Easter egg: lantern + force_gate combo reveals a small side boon
          if(state.tookLantern && state.grumpy){ lines.push(`Finn’s lantern still glows. A soft beam points to a note wedged under the dais: <em>Ask before you take</em>.`); }
          lines.push(`At the dais, two paths brighten.`);
          return lines.join(' ');
        },
        choices: [
          { label: "Embrace the legacy—become a junior Gatekeeper.", go: "ending_legacy" },
          { label: "Seek further mysteries beyond the academy.", go: "ending_wander" },
          // Hidden choice appears only with lantern+grumpy combo
          { label: "Follow the lantern’s beam (secret).", go: "secret_well", if(){ return state.tookLantern && state.grumpy; } },
        ]
      },

      ending_legacy: {
        text(){
          return state.boon
            ? `Aurelius’s shadow crowns you. Lyra smiles as if she always knew. <strong>Elara Thornfield</strong>, Gatekeeper of Astralyn: starlight bends a little more kindly around your name.`
            : `You kneel at the dais and the sigil acknowledges you. Not favored—yet chosen. Gatekeeping begins in humility.`;
        },
        choices: [ { label: "✦ The End (for now) — Restart", go: "reset" } ]
      },

      ending_wander: {
        text: `You copy the maps, tuck the moon‑sigil close, and slip into night. Stars wheel like doorways. Somewhere, a second gate waits for a name you haven’t learned yet.`,
        choices: [ { label: "✦ The End (for now) — Restart", go: "reset" }, { label: "More to come…", go: "post_credits" } ]
      },

      // --- Secret scenes ---
      secret_annex_hint: {
        text: `A shelf clicks. A draft like cold ink. Between biographies and bestiaries, the wood is hollow. A sigil glows—three stars in a row.`,
        choices: [ { label: "Memorize the sigil and retreat.", go: "star_corridor" } ]
      },

      secret_annex: {
        enter(){ sfx.success(); },
        text: `The wheels settle on a forbidden harmony: ✹✹✹. The floor releases a hush. You drop—not down, but aside—into the <strong>Auric Annex</strong>, a pocket study where time passes like turning pages. On a lectern: a map fragment pointing beyond Astralyn’s walls to a <em>constellation well</em>.`,
        choices: [
          { label: "Pocket the fragment and return to the riddle room.", go: "riddle" },
          { label: "Use the Annex door and skip to the rotunda.", go: "revelation" },
        ]
      },

      secret_drift: {
        enter(){ sfx.fail(); },
        text: `Your third mistake thins the corridor into fog. You find yourself on the <strong>Drift Between</strong>—a pale copy of the star hall where footsteps echo before they land. A hum in the haze: <em>Ask before you take</em>.`,
        choices: [
          { label: "Promise aloud to ask—and try again.", go: "riddle" },
          { label: "Force the way regardless.", go: "force_gate" },
        ]
      },

      // New secret: helpful specter if you spam hints without turning wheels
      secret_specter: {
        text: `A patient flicker gathers at your shoulder. “Hints are for learning, not scolding,” the specter whispers, tapping the nearest wheel. The correct symbol glides into place.` ,
        enter(){ state.boon = true; },
        choices: [ { label: "Try the riddle again.", go: "riddle" } ]
      },

      // New secret: lantern + grumpy path reveals the constellation well
      secret_well: {
        enter(){ state.notes.finnDeep = true; },
        text: `The lantern’s beam threads a line between floor tiles to a trapdoor etched with three tiny stars. Below waits a shallow <strong>constellation well</strong>, reflecting not your face but a map of nearby gates. One glows brighter when your moon‑sigil nears.`,
        choices: [ { label: "Close the well and return to the dais.", go: "revelation" } ]
      },

      post_credits: {
        text: `Thank you for walking Astralyn’s halls. New chapters are brewing. Follow updates and return soon.`,
        choices: [ { label: "Restart adventure", go: "reset" } ]
      },

      reset: { text: "", choices: [] }
    };

    function doRender(id){
      const node = scenes[id]; if(!node) return;
      if(typeof node.enter === 'function') node.enter();
      state.visited.add(id);

      if(typeof node.customRender === 'function'){
        $scene.innerHTML = ''; $choices.innerHTML = '';
        node.customRender();
      } else {
        const text = typeof node.text === 'function' ? node.text() : node.text;
        $scene.innerHTML = `<p>${text}</p>`;
        $choices.innerHTML = '';
        node.choices.forEach(c => {
          // optional conditional choices
          if(typeof c.if === 'function' && !c.if()) return;
          const b = document.createElement('button'); b.className = 'choice'; b.textContent = c.label; b.addEventListener('click', ()=> { if(typeof c.on==='function') c.on(); render(c.go); }); $choices.appendChild(b);
        });
      }

      // HUD status
      const chapter = id.startsWith('ending') ? 'Epilogue' : (id==='prologue' || id==='howto') ? 'Prelude' : 'Chapter One';
      const tags = ["Elara", chapter]; if(state.lore) tags.push('Lore'); if(state.boon) tags.push('Boon'); if(state.grumpy) tags.push('Aurelius: wary');
      $status.textContent = tags.join(' · ');

      // back button state
      $back.disabled = state.history.length === 0; $back.style.opacity = $back.disabled ? .5 : 1;

      history.replaceState(null, '', `#${encode(id)}`);
    }

    function render(id){
      if(id === 'reset'){ Object.assign(state, { lore:false, boon:false, grumpy:false, fails:0, tookLantern:false, history:[], visited:new Set(), characters:{elara:true,finn:false,lyra:false,aurelius:false}, notes:{finnDeep:false,aureliusDeep:false} }); return render('prologue'); }
      // push current route for back stack
      const current = currentId(); if(current && current !== id) state.history.push(current);
      doRender(id);
    }

    // shareable hash routing with flags
    function encode(id){ const flags = [state.lore?'1':'0', state.boon?'1':'0', state.grumpy?'1':'0', state.fails, state.tookLantern?'1':'0'].join(''); return `${id}|${flags}`; }
    function decode(hash){ const [id] = (hash || '').split('|'); return id || 'prologue'; }

    document.getElementById('restart').addEventListener('click', ()=> render('reset'));
    document.getElementById('share').addEventListener('click', ()=>{
      const url = location.href.split('#')[0] + '#' + encode(currentId());
      navigator.clipboard.writeText(url).then(()=>{ const btn = document.getElementById('share'); const old = btn.textContent; btn.textContent = 'Copied!'; setTimeout(()=> btn.textContent = old, 1200); });
    });
    document.getElementById('sound').addEventListener('click', toggleAmbience);
    $back.addEventListener('click', ()=>{ if(state.history.length){ const prev = state.history.pop(); doRender(prev); } });

    function currentId(){ const h = location.hash.slice(1); return (h.split('|')[0] || 'prologue'); }

    // fail → secret drift
    const _render = render; render = function(id){ if(id==='fail'){ state.fails++; if(state.fails>=2) { doRender('secret_drift'); return; } } _render(id); };

    // --- Journal logic ---
    const $overlay = document.getElementById('journalOverlay');
    const $journalBody = document.getElementById('journalBody');
    const $journalBtn = document.getElementById('journalBtn');
    if($journalBtn){ $journalBtn.addEventListener('click', ()=>{ updateJournal(); $overlay.classList.add('show'); }); }
    const $closeJournal = document.getElementById('closeJournal');
    if($closeJournal){ $closeJournal.addEventListener('click', ()=> $overlay.classList.remove('show')); }
    if($overlay){ $overlay.addEventListener('click', (e)=>{ if(e.target===$overlay) $overlay.classList.remove('show'); }); }

    function entryHTML(title, summary, detail=null, sigil='✧'){
      return `<div class="entry"><span class="sigil">${sigil}</span><h3>${title}</h3><p>${summary}</p>${detail?`<p><small>${detail}</small></p>`:''}</div>`;
    }
    function updateJournal(){
      const parts = [];
      parts.push(entryHTML('Elara Thornfield', 'New to Astralyn, curious and steady. Drawn by rumors of a violet door.', 'Some say she studied at a library that no longer exists.'));
      if(state.characters && state.characters.finn){
        let detail = state.notes && state.notes.finnDeep ? 'His lantern belonged to his sister, who vanished here two winters ago.' : 'Boots dusty with places he claims not to visit.';
        parts.push(entryHTML('Finn Alderidge', 'Warm smile, watchful eyes. Shows up when halls go quiet.', detail, '✦'));
      }
      if(state.characters && state.characters.lyra){
        parts.push(entryHTML('Lyra Windmere', 'Keeper of the stacks. Files books others swear were never there.', 'She has a key that opens no door—until it does.', '✹'));
      }
      if(state.characters && state.characters.aurelius){
        let detail = state.notes && state.notes.aureliusDeep ? 'He favors those who ask before they take. His patience is older than the brickwork.' : 'A voice like a bell struck in stone.';
        parts.push(entryHTML('Aurelius', 'The gate’s dragon guardian.', detail, '✺'));
      }
      if($journalBody) $journalBody.innerHTML = parts.join('');
    }

    // Hook journal updates + unlocks based on current scene id
    const __doRenderHook = doRender;
    doRender = function(id){
      // unlock flags from scene ids without editing every scene
      if(id==='star_corridor'){ state.characters.finn = true; }
      if(id==='with_lyra'){ state.characters.lyra = true; }
      if(id==='guardian' || id==='guardian_alone'){ state.characters.aurelius = true; }
      if(id==='secret_well'){ state.notes.finnDeep = true; }
      if(id==='revelation' && state.boon){ state.notes.aureliusDeep = true; }
      __doRenderHook(id);
      updateJournal();
    }

    // Splash logic + Initialize
    const $splash = document.getElementById('splash');
    const $startGame = document.getElementById('startGame');
    const $viewJournal = document.getElementById('viewJournal');
    if($startGame){ $startGame.addEventListener('click', ()=>{ $splash.hidden = true; render('prologue'); }); }
    if($viewJournal){ $viewJournal.addEventListener('click', ()=>{ updateJournal(); $overlay.classList.add('show'); }); }

    function shouldShowSplash(){ return !location.hash || location.hash === '#'; }

    if(shouldShowSplash()){
      $splash.hidden = false;
    } else {
      const startId = decode(location.hash.slice(1));
      doRender(startId);
    }
